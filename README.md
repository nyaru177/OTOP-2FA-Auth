# OTOP-2FA-Auth

OTOP-2FA-Auth 是一个基于 Express.js 的高安全性三级身份认证系统，提供多重身份验证保障，并有效防止重放攻击。

## 核心安全特性

### 三级身份认证
1. **密码认证**
   - 强密码策略（大小写字母、数字、特殊字符）
   - 密码加密存储（bcrypt）
   - 防暴力破解（登录失败次数限制）

2. **邮箱验证**
   - 邮箱验证码认证
   - 验证码时效性控制（3分钟有效期）
   - 防刷验证码（15分钟内最多5次请求）

3. **双因素认证(2FA)**
   - TOTP 动态令牌
   - 基于时间的一次性密码（30秒刷新）
   - 支持主流验证器应用（如 Google Authenticator）

4. **惟一数机制 (Nonce)**
   - 每次身份认证请求生成惟一的 `nonce` 和时间戳，用于防止重放攻击。
   - `nonce` 和时间戳存储在会话中，确保每次认证请求的唯一性。

### 安全防护措施
- **会话管理**
  - Redis 分布式会话存储，支持高效的会话管理
  - 会话有效期控制（默认1小时自动过期）
  - 安全的 Cookie 配置，防止会话劫持

- **访问控制**
  - CSRF 防护，防止跨站请求伪造攻击
  - 请求速率限制，防止滥用
  - 登录尝试次数限制（5次失败后锁定账户15分钟）

- **数据安全**
  - MySQL 数据持久化存储，确保数据安全
  - 敏感信息加密存储（如密码）
  - 数据库连接池管理，优化性能

## 技术栈
- Node.js 22
- Express.js
- MySQL 8.0+
- Redis 7.0+
- Docker

## 快速开始

### 本地环境配置
1. **MySQL**  
   - 运行 `/db_init/init.sql` 初始化数据库结构
   - 配置 `config/mysql.js` 连接信息

2. **Redis**  
   - 配置 `config/redis.js` 连接信息

3. **安装依赖**
   ```bash
   yarn install
   ```

4. **启动服务**
   - 生产环境:
     ```bash
     yarn start
     ```
   - 开发环境:
     ```bash
     yarn run dev
     ```

### Docker 部署
一键启动所有服务:
```bash
./run.sh
```

### 访问地址
- 本地访问: [http://localhost:3020](http://localhost:3020)

## 系统架构
```
├── 用户认证模块
│   ├── 密码认证
│   ├── 邮箱验证
│   └── TOTP 双因素认证
├── 会话管理模块
│   ├── Redis 分布式存储
│   └── 会话状态控制
└── 安全防护模块
    ├── CSRF 防护
    ├── 速率限制
    └── 暴力破解防护
```

## 安全配置
- **密码策略**：至少8位，包含大小写字母、数字和特殊字符
- **验证码限制**：15分钟内最多5次请求
- **登录保护**：5次失败后锁定15分钟
- **会话时效**：1小时自动过期
- **TOTP**：30秒刷新的动态令牌
- **惟一数机制**：每次认证请求使用 `nonce` 和时间戳，防止重放攻击